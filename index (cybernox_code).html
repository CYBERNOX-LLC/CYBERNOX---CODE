<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBERNOX-CODE - Advanced AI Code Generation Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            background-image:
                radial-gradient(circle at 25% 25%, #1a1a2e 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #16213e 0%, transparent 50%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid #333;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            text-align: left;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .header .brand {
            font-size: 0.9rem;
            color: #00d4ff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .main-content {
            padding: 30px;
        }

        .mode-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 10px;
            border: 1px solid #333;
        }

        .mode-toggle {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-toggle.generator {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .mode-toggle.rehab {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .mode-indicator {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00d4ff;
        }

        .input-section {
            background: rgba(20, 20, 30, 0.8);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #00d4ff;
        }

        .input-field, .textarea-field, .select-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus, .textarea-field:focus, .select-field:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .large-textarea {
            min-height: 200px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap; 
            gap: 15px;
            align-items: center;
        }

        .clear-btn {
            padding: 15px 30px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #4b5563, #374151);
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(55, 65, 81, 0.4); 
        }

        .generate-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .pipeline-progress {
            display: none;
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 3px;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stage-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stage-card {
            background: rgba(40, 40, 50, 0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
            text-align: center;
        }

        .stage-card.active {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .stage-card.completed {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .results-section {
            background: rgba(20, 20, 30, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #333;
            display: none;
        }

        .quality-metrics {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .confidence-bar {
            width: 200px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .security-badge {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .code-display, .setup-display {
            background: #1a1a1a;
            border-radius: 10px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .result-header {
            background: #2a2a3a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .result-header h4 {
            color: #00d4ff;
            font-size: 1.1rem;
        }

        .copy-btn, .editor-btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 12px;
        }

        .copy-btn:hover, .editor-btn:hover {
            background: #0099cc;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: #27ae60;
        }

        .code-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .code-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            background: #111;
            padding: 15px;
            border-radius: 5px;
        }

        .setup-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.6;
        }

        /* MINI IDE PREVIEW INTEGRATION */
        .preview-section {
            display: none;
            background: rgba(20, 20, 30, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .preview-container {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #00d4ff;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
        }

        .preview-container iframe {
            width: 100%;
            height: 500px;
            border: none;
            background-color: white;
        }

        /* Enhanced iframe isolation */
        #preview-frame {
            width: 100%;
            height: 500px;
            border: none;
            background-color: white;
        }

        /* MINI IDE MODAL */
        .mini-ide-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            backdrop-filter: blur(5px);
        }

        .mini-ide-container {
            width: 100%;
            height: 100%;
            background: #121212;
            display: flex;
            flex-direction: column;
        }

        /* MINI IDE STYLES EMBEDDED */
        :root {
            --bg-deep: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2a2a2a;
            --border-color: #383838;
            --text-primary: #d4d4d4;
            --text-secondary: #888888;
            --accent-primary: #00aaff;
            --accent-danger: #e57373;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-code: 'Menlo', 'Monaco', 'Courier New', monospace;
            --sidebar-width: 280px;
        }

        .ide-header {
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 50px;
            background-color: var(--bg-medium);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .ide-header-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .ide-desktop-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .ide-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-medium);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, min-width 0.3s ease;
            flex-shrink: 0;
        }

        .ide-main-content {
            flex: 1;
            display: flex;
            min-width: 0;
        }

        .ide-panel {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-deep);
            flex: 1;
            min-width: 0;
        }

        .ide-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--bg-light);
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
            height: 40px;
            color: var(--text-primary);
        }

        .ide-panel-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .ide-btn {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .ide-btn:hover {
            background-color: #444;
        }

        .ide-btn.btn-primary {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .ide-btn.btn-primary:hover {
            background-color: #0090d8;
        }

        .ide-btn.btn-danger {
            background-color: transparent;
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .ide-btn.btn-danger:hover {
            background-color: var(--accent-danger);
            color: white;
        }

        .ide-controls {
            display: flex;
            gap: 8px;
        }

        #ide-code-input {
            width: 100%;
            height: 100%;
            background: var(--bg-deep);
            color: var(--text-primary);
            font-family: var(--font-code);
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
            border: none;
            outline: none;
            resize: none;
        }

        #ide-preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        #ide-resizer {
            flex: 0 0 5px;
            background-color: var(--border-color);
            cursor: col-resize;
            transition: background-color 0.2s;
        }

        #ide-resizer:hover {
            background-color: var(--accent-primary);
        }

        .ide-footer {
            padding: 8px 20px;
            font-size: 0.8rem;
            background-color: var(--bg-medium);
            border-top: 1px solid var(--border-color);
            text-align: right;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .platform-tab {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 20px;
        }

        .platform-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .chat-section {
            background: rgba(20, 20, 30, 0.8);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .chat-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #333;
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 6px;
            position: relative;
        }

        .user-message {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid #00d4ff;
        }

        .assistant-message {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid #27ae60;
        }

        .system-message {
            background: rgba(155, 89, 182, 0.1);
            border-left: 4px solid #9b59b6;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #00d4ff;
        }

        .message-content {
            margin-right: 60px;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        .chat-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .chat-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .footer {
            background: rgba(20, 20, 30, 0.95);
            border-top: 2px solid #333;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .footer-brand {
            color: #00d4ff;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .protect-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b, #e74c3c);
            background-size: 200% 100%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            overflow: hidden;
            animation: shimmer 3s ease-in-out infinite;
            position: relative;
        }

        .protect-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: slide 2.5s ease-in-out infinite;
        }

        .protect-btn:hover {
            transform: translateY(-2px) scale(1.05);
            background-position: 100% 0;
        }

        @keyframes shimmer {
            0%, 100% {
                background-position: 0% 0%;
            }
            50% {
                background-position: 100% 0%;
            }
        }

        @keyframes slide {
            0%, 100% {
                left: -100%;
            }
            50% {
                left: 100%;
            }
        }

        .footer-divider {
            width: 1px;
            height: 30px;
            background: linear-gradient(to bottom, transparent, #333, transparent);
        }

        .footer-tagline {
            color: #999;
            font-size: 0.8rem;
            font-style: italic;
        }

        .sessions-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #111;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sessions-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(30, 30, 40, 0.98);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: #00d4ff;
            font-size: 1.5rem;
        }

        .modal-close-btn {
            font-size: 2rem;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
            background: none;
            border: none;
        }

        .modal-close-btn:hover {
            color: white;
        }

        .save-session-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(10, 10, 20, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }

        .save-input-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .save-input-row .input-field {
            flex: 1;
            margin: 0;
        }

        .save-session-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 120px;
        }

        .save-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        #savedSessionsList {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            padding: 10px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            background: linear-gradient(135deg, rgba(40, 40, 50, 0.9), rgba(50, 50, 60, 0.8));
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #555;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            border-color: #00d4ff;
            background: linear-gradient(135deg, rgba(40, 40, 50, 1), rgba(50, 50, 60, 0.9));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .session-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .session-item-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #00d4ff;
        }

        .session-item-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.9rem;
            color: #bbb;
        }

        .session-timestamp {
            color: #888;
            font-size: 0.8rem;
        }

        .session-mode-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .session-mode-generator {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .session-mode-rehab {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .session-item-actions button {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 700;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .load-session-btn {
            background: #27ae60;
            color: white;
        }
        .load-session-btn:hover {
            background: #2ecc71;
        }
        .delete-session-btn {
            background: #c0392b;
            color: white;
        }
        .delete-session-btn:hover {
            background: #e74c3c;
        }

        .no-sessions-msg {
            text-align: center;
            padding: 40px;
            color: #777;
            font-style: italic;
        }

        .error-display {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #e74c3c;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(40, 40, 50, 0.8);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0099cc, #007399);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            .header-title {
                text-align: center;
            }
            .header h1 {
                font-size: 2rem;
            }

            .mode-section {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .input-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .stage-status {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .quality-metrics {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .confidence-bar {
                width: 100%;
            }

            .chat-input-group {
                flex-direction: column;
            }

            .footer-content {
                flex-direction: column;
                gap: 15px;
            }

            .footer-divider {
                width: 60px;
                height: 1px;
                background: linear-gradient(to right, transparent, #333, transparent);
            }

            .pipeline-progress {
                padding: 15px;
            }

            .stage-status {
                gap: 10px;
            }

            .save-input-row {
                flex-direction: column;
            }

            .session-item {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .session-item-actions {
                align-self: flex-end;
            }
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .stage-status {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .stage-card {
                padding: 12px;
                font-size: 0.9rem;
            }

            .mode-toggle {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <h1>üß† CYBERNOX-CODE</h1>
                <p>Advanced AI Code Generation Platform</p>
                <div class="brand">Powered by CYBERNOX LLC</div>
            </div>
            <button class="sessions-btn" id="manageSessionsBtn">üìÇ Manage Sessions</button>
        </div>

        <div class="main-content">
            <div class="mode-section">
                <button class="mode-toggle generator" id="modeToggle">‚ö° Code Generator</button>
                <div class="mode-indicator" id="modeIndicator">‚ö° AI Code Generation Mode</div>
            </div>

            <div class="input-section" id="generatorSection">
                <h3 class="section-title">‚ö° Code Generation</h3>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label for="requirements">Project Requirements</label>
                        <textarea 
                            id="requirements" 
                            class="textarea-field large-textarea"
                            placeholder="Describe your project in detail..."
                        ></textarea>
                    </div>

                    <div class="input-group">
                        <label for="language">Programming Language</label>
                        <select id="language" class="select-field">
                            <option value="html">HTML/CSS/JavaScript</option>
                            <option value="react">React Component</option>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="node">Node.js</option>
                            <option value="css">CSS/Styling</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="generate-btn" id="generateBtn">üöÄ Generate Secure Code</button>
                    <button class="clear-btn" id="clearGeneratorBtn">üßπ Clear</button>
                </div>
            </div>

            <div class="input-section" id="rehabSection" style="display: none;">
                <h3 class="section-title">üöë Code Rehabilitation</h3>
                
                <div class="input-group">
                    <label for="brokenCode">Paste Your Broken Code</label>
                    <textarea 
                        id="brokenCode" 
                        class="textarea-field large-textarea"
                        placeholder="Paste the code that needs fixing..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="problemDescription">Describe the Problems</label>
                    <textarea 
                        id="problemDescription" 
                        class="textarea-field"
                        placeholder="Describe what's wrong..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="rehabLanguage">Code Language</label>
                    <select id="rehabLanguage" class="select-field">
                        <option value="html">HTML/CSS/JavaScript</option>
                        <option value="react">React</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="node">Node.js</option>
                        <option value="css">CSS</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="generate-btn" id="rehabBtn">üöë Rehabilitate Code</button>
                    <button class="clear-btn" id="clearRehabBtn">üßπ Clear</button>
                </div>
            </div>

            <div class="pipeline-progress" id="pipelineProgress">
                <h3>üîÑ AI Pipeline Working...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="stage-status" id="stageStatus">
                    <div class="stage-card" id="stage-generator">
                        <strong>üéØ Generator</strong><br>
                        <small>Initial Code Creation</small>
                    </div>
                    <div class="stage-card" id="stage-security">
                        <strong>üõ°Ô∏è Security Audit</strong><br>
                        <small>Vulnerability Check</small>
                    </div>
                    <div class="stage-card" id="stage-optimizer">
                        <strong>‚ö° Optimizer</strong><br>
                        <small>Performance Enhancement</small>
                    </div>
                    <div class="stage-card" id="stage-validator">
                        <strong>‚úÖ Validator</strong><br>
                        <small>Quality Assurance</small>
                    </div>
                    <div class="stage-card" id="stage-fulfillment">
                        <strong>üéØ Fulfillment</strong><br>
                        <small>Requirements Check</small>
                    </div>
                </div>
            </div>

            <div class="error-display" id="errorDisplay"></div>

            <div class="results-section" id="resultsSection">
                <h3>üìä Generated Results</h3>
                
                <div class="quality-metrics">
                    <div class="confidence-meter">
                        <span><strong>Quality Score:</strong></span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidenceFill"></div>
                        </div>
                        <span id="confidenceText"><strong>0%</strong></span>
                    </div>
                    <div class="security-badge">
                        üõ°Ô∏è Security Validated
                    </div>
                </div>

                <div class="results-grid">
                    <div class="code-display">
                        <div class="result-header">
                            <h4 id="codeTitle">üìù Generated Code</h4>
                            <div class="ide-controls" id="codeControls">
                                <button class="copy-btn" id="copyCodeBtn">üìã Copy</button>
                                <button class="editor-btn" id="editCodeBtn">‚úèÔ∏è Edit Code</button>
                            </div>
                        </div>
                        <div class="code-content" id="codeContent"></div>
                    </div>

                    <div class="setup-display">
                        <div class="result-header">
                            <h4>üöÄ Setup Guide</h4>
                            <button class="copy-btn" id="copySetupBtn">üìã Copy</button>
                        </div>
                        <div class="setup-content" id="setupContent"></div>
                    </div>
                </div>
            </div>

            <div class="preview-section" id="previewSection">
                <h3 class="section-title">üëÅÔ∏è Live Preview</h3>
                <div class="preview-container" id="previewContainer">
                    <iframe id="preview-frame" sandbox="allow-scripts allow-forms allow-modals allow-same-origin"></iframe>
                </div>
            </div>

            <div class="chat-section">
                <h3 class="section-title">üí¨ AI Assistant</h3>
                
                <div class="chat-container" id="chatContainer"></div>

                <div class="chat-input-group">
                    <input 
                        type="text" 
                        id="chatInput" 
                        class="input-field chat-input"
                        placeholder="Ask questions or describe what you want to build..."
                    >
                    <button class="chat-btn" id="chatBtn">üì§ Send</button>
                </div>
            </div>

            <div class="footer">
                <div class="footer-content">
                    <div class="footer-brand">üõ°Ô∏è CYBERNOX LLC</div>
                    <div class="footer-divider"></div>
                    <button class="protect-btn" onclick="window.open('https://www.cybernox-security.com', '_blank')">
                        üõ°Ô∏è Protect
                    </button>
                    <div class="footer-divider"></div>
                    <button class="protect-btn" onclick="window.open('https://www.cybernox-digital-ecosystem.com', '_blank')">Advanced AI Solutions & Cybersecurity</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Management Modal -->
    <div class="modal-backdrop" id="sessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÇ Session Management</h3>
                <button class="modal-close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <h4 class="section-title" style="font-size: 1.2rem;">üíæ Save Current Session</h4>
                <div class="save-session-section">
                    <div class="save-input-row">
                        <input type="text" id="sessionNameInput" class="input-field" placeholder="Enter session name (optional - auto-generated if empty)...">
                        <button class="save-session-btn" id="saveSessionBtn">üíæ Save Session</button>
                    </div>
                    <div style="font-size: 0.9rem; color: #888; margin-top: 10px;">
                        üí° Sessions automatically include timestamps and current mode
                    </div>
                </div>

                <h4 class="section-title" style="font-size: 1.2rem;">üóÇÔ∏è Saved Sessions</h4>
                <div id="savedSessionsList">
                </div>
            </div>
        </div>
    </div>

    <!-- MINI IDE MODAL -->
    <div class="mini-ide-modal" id="miniIdeModal">
        <div class="mini-ide-container">
            <header class="ide-header">
                <button class="platform-tab" id="backToPlatformBtn">üîô Back to Platform</button>
                <span class="ide-header-title" style="margin-left: 20px;">CYBERNOX IDE</span>
            </header>
            <div class="ide-desktop-container">
                <main class="ide-main-content">
                    <div class="ide-panel editor-panel">
                        <div class="ide-panel-header">
                            <span>‚ö° Editor</span>
                            <div class="ide-controls">
                                <button class="ide-btn format-code-btn">Format</button>
                                <button class="ide-btn ide-btn-danger clear-code-btn">Clear</button>
                            </div>
                        </div>
                        <div class="ide-panel-content"><textarea id="ide-code-input" spellcheck="false"></textarea></div>
                    </div>
                    <div id="ide-resizer"></div>
                    <div class="ide-panel preview-panel">
                        <div class="ide-panel-header">
                            <span>üî¥ Preview</span>
                            <button class="ide-btn" onclick="miniIDE.updatePreview(true)">‚ñ∂ Run</button>
                        </div>
                        <div class="ide-panel-content"><iframe id="ide-preview-frame" sandbox="allow-scripts allow-forms allow-modals allow-same-origin"></iframe></div>
                    </div>
                </main>
            </div>
            <footer class="ide-footer">
                <a href="https://cybernox-digital-ecosystem.com" target="_blank">CYBERNOX LLC</a> &copy; 2025
            </footer>
        </div>
    </div>

    <script>
        /**
         * CYBERNOX-CODE Platform - Integrated with Mini IDE
         * Advanced AI Code Generation & Rehabilitation System
         */

        // Configuration constants
        const CONFIG = {
            API_BASE_URL: 'https://text.pollinations.ai',
            AI_MODELS: ['openai-fast ', 'openai-fast ', 'openai-fast ', 'openai-fast ', 'openai-fast '],
            MAX_PROMPT_LENGTH: 8000,
            STAGE_DELAY_MS: 500,
            NOTIFICATION_DURATION: 3000,
            PREVIEW_HEIGHT: 500,
            STORAGE_KEYS: {
                CHAT_HISTORY: 'cybernoxChatHistory',
                SESSIONS: 'cybernoxSessions',
                IDE_SESSIONS: 'cybernoxIdeSessions'
            }
        };

        /**
         * Mini IDE Integration - IndexedDB Manager
         */
        class IndexedDBManager {
            constructor(dbName, storeName, version = 1) {
                this.dbName = dbName;
                this.storeName = storeName;
                this.version = version;
                this.db = null;
            }

            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains(this.storeName)) {
                            this.db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject(event.target.error);
                    }
                });
            }

            add(data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            getAll() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result.reverse());
                    request.onerror = () => reject(request.error);
                });
            }

            delete(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        /**
         * Mini IDE Editor Integration
         */
        class MiniIDE {
            constructor() {
                this.db = new IndexedDBManager('CYBERNOX_IDE_DB', 'sessions');
                this.elements = {
                    modal: document.getElementById('miniIdeModal'),
                    codeInput: document.getElementById('ide-code-input'),
                    previewFrame: document.getElementById('ide-preview-frame'),
                    resizer: document.getElementById('ide-resizer'),
                    editorPanel: document.querySelector('.editor-panel'),
                    backBtn: document.getElementById('backToPlatformBtn')
                };
                this.updateTimer = null;
                this.currentCode = '';
                this.init();
            }

            async init() {
                await this.db.init();
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.elements.codeInput.addEventListener('input', () => this.scheduleUpdate());
                this.elements.backBtn.addEventListener('click', () => this.backToPlatform());
                
                document.querySelectorAll('.format-code-btn').forEach(btn => 
                    btn.addEventListener('click', () => this.formatCode()));
                document.querySelectorAll('.clear-code-btn').forEach(btn => 
                    btn.addEventListener('click', () => this.clearCode()));

                this.elements.resizer.addEventListener('mousedown', (e) => this.initResize(e));
            }

            show(code = '') {
                this.elements.modal.style.display = 'block';
                if (code) {
                    this.loadCode(code);
                }
                this.elements.codeInput.focus();
            }

            hide() {
                this.elements.modal.style.display = 'none';
            }

            loadCode(code) {
                this.currentCode = code;
                this.elements.codeInput.value = code;
                this.updatePreview(true);
            }

            backToPlatform() {
                // Save current code to platform session
                if (this.currentCode !== this.elements.codeInput.value) {
                    this.syncWithPlatform();
                }
                this.hide();
            }

            async syncWithPlatform() {
                const code = this.elements.codeInput.value;
                
                // Save to Mini IDE sessions
                try {
                    const sessionName = this.extractSessionName(code);
                    await this.db.add({ 
                        name: sessionName, 
                        code: code, 
                        timestamp: Date.now(),
                        source: 'platform'
                    });
                } catch (error) {
                    console.error('Failed to save to Mini IDE:', error);
                }

                // Sync with platform sessions
                if (window.ui && window.ui.currentResult) {
                    window.ui.currentResult.finalCode = code;
                    window.ui.saveCurrentSession();
                }
            }

            extractSessionName(code) {
                const doc = new DOMParser().parseFromString(code, "text/html");
                const titleTag = doc.querySelector('title');
                return titleTag ? titleTag.textContent.trim() : `IDE Session - ${new Date().toLocaleString()}`;
            }

            scheduleUpdate() {
                clearTimeout(this.updateTimer);
                this.updateTimer = setTimeout(() => this.updatePreview(), 500);
            }

            updatePreview(force = false) {
                if (force) {
                    clearTimeout(this.updateTimer);
                }
                let code = this.elements.codeInput.value;
                if (!code.trim()) {
                    this.elements.previewFrame.srcdoc = '<body style="padding:20px;color:#666;font-family:sans-serif;">Preview will appear here...</body>';
                    return;
                }
                const processedCode = this.processCodeForPreview(code);
                this.elements.previewFrame.srcdoc = processedCode;
            }

            // COMPLETE ISOLATION - EXACT SAME SYSTEM FOR MINI IDE
            processCodeForPreview(code) {
                const cspMetaTagRegex = /<meta http-equiv="Content-Security-Policy"[^>]*>/gi;
                let processedCode = code.replace(cspMetaTagRegex, '');
                
                // SAME ISOLATION SCRIPT FOR MINI IDE
                const isolationScript = `<script>
(function() {
    'use strict';
    
    // BLOCK ALL PARENT ACCESS
    try {
        Object.defineProperty(window, 'parent', { value: window, writable: false });
        Object.defineProperty(window, 'top', { value: window, writable: false });
        Object.defineProperty(window, 'frameElement', { value: null, writable: false });
    } catch(e) {}
    
    // OVERRIDE NAVIGATION TO STAY IN IFRAME
    const originalOpen = window.open;
    window.open = function() { return window; };
    
    // BLOCK POSTMESSAGE TO PARENT
    const originalPostMessage = window.postMessage;
    window.postMessage = function(message, targetOrigin) {
        return originalPostMessage.call(window, message, window.location.origin);
    };
    
    // HANDLE ALL NAVIGATION WITHIN IFRAME
    document.addEventListener('DOMContentLoaded', function() {
        
        // OVERRIDE ALL ANCHOR CLICKS TO STAY IN IFRAME
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (!link) return;
            
            const href = link.getAttribute('href');
            if (!href) return;
            
            // Handle hash links within iframe (like #menu, #locations)
            if (href.startsWith('#')) {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
                return;
            }
            
            // Block external navigation - keep everything in iframe
            if (href.startsWith('http') || href.startsWith('//') || href.startsWith('mailto:') || href.startsWith('tel:')) {
                e.preventDefault();
                console.log('External link blocked in preview:', href);
                return;
            }
        }, true);
        
        // OVERRIDE FORM SUBMISSIONS TO STAY IN IFRAME
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (!form.tagName || form.tagName.toLowerCase() !== 'form') return;
            
            const action = form.getAttribute('action');
            if (action && (action.startsWith('http') || action.startsWith('//'))) {
                e.preventDefault();
                console.log('External form submission blocked in preview');
                
                const formData = new FormData(form);
                console.log('Form data (preview only):', Object.fromEntries(formData));
                
                const event = new CustomEvent('formSuccess', { detail: { formData } });
                form.dispatchEvent(event);
            }
        }, true);
        
        // BLOCK WINDOW LOCATION CHANGES
        const originalLocation = window.location;
        Object.defineProperty(window, 'location', {
            get: function() { return originalLocation; },
            set: function(value) { 
                console.log('Location change blocked in preview:', value);
                return originalLocation; 
            }
        });
        
        // BLOCK HISTORY API THAT MIGHT AFFECT PARENT
        const originalPushState = history.pushState;
        const originalReplaceState = history.replaceState;
        
        history.pushState = function(state, title, url) {
            if (url && url.startsWith('#')) {
                return originalPushState.call(history, state, title, url);
            }
            console.log('History change blocked in preview');
        };
        
        history.replaceState = function(state, title, url) {
            if (url && url.startsWith('#')) {
                return originalReplaceState.call(history, state, title, url);
            }
            console.log('History change blocked in preview');
        };
    });
    
})();
<\/script>`;
                
                if (processedCode.toLowerCase().includes('<head>')) {
                    processedCode = processedCode.replace(/<head>/i, '<head>' + isolationScript);
                } else if (processedCode.toLowerCase().includes('<html')) {
                    processedCode = processedCode.replace(/<html[^>]*>/i, '$&<head>' + isolationScript + '</head>');
                } else {
                    processedCode = isolationScript + processedCode;
                }
                
                return processedCode;
            }

            formatCode() {
                let code = this.elements.codeInput.value;
                code = code.replace(/></g, '>\n<').replace(/{\s*/g, '{\n  ').replace(/;\s*/g, ';\n').replace(/}\s*/g, '}\n');
                this.elements.codeInput.value = code;
                this.updatePreview(true);
            }

            clearCode() {
                if (confirm('Are you sure you want to clear the editor? This cannot be undone.')) {
                    this.elements.codeInput.value = '';
                    this.elements.codeInput.focus();
                    this.updatePreview(true);
                }
            }

            initResize(e) {
                e.preventDefault();
                const startX = e.clientX;
                const startWidth = this.elements.editorPanel.offsetWidth;
                const doDrag = (moveEvent) => {
                    const newWidth = startWidth + (moveEvent.clientX - startX);
                    if (newWidth > 150 && newWidth < (this.elements.editorPanel.parentElement.offsetWidth - 150)) {
                        this.elements.editorPanel.style.flex = `0 0 ${newWidth}px`;
                    }
                };
                const stopDrag = () => {
                    document.documentElement.removeEventListener('mousemove', doDrag);
                    document.documentElement.removeEventListener('mouseup', stopDrag);
                };
                document.documentElement.addEventListener('mousemove', doDrag);
                document.documentElement.addEventListener('mouseup', stopDrag);
            }
        }

        /**
         * Core AI Code Generation Engine
         */
        class CodeGenerator {
            constructor() {
                this.baseURL = CONFIG.API_BASE_URL;
                this.models = CONFIG.AI_MODELS;
                this.attempts = [];
                this.isRehabMode = false;
                this.chatHistory = [];
            }

            generatePrompt(requirements, language, stage) {
                const prompts = {
                    1: `Generate complete ${language} code for: ${requirements}

REQUIREMENTS:
- Write 100% complete, functional code with zero placeholders
- Include all necessary HTML, CSS, and JavaScript
- Add proper input validation and security protections
- Make immediately runnable
- Add comprehensive comments and documentation
- Use modern best practices

Generate the complete solution:`,

                    2: `Security audit and improvement for this ${language} code:

${this.attempts[0]?.response || ''}

SECURITY CHECKLIST:
- Fix all syntax errors and bugs
- Add input validation and sanitization
- Remove security vulnerabilities
- Ensure XSS protection
- Add error handling
- Optimize for production

Return the complete corrected and secured code:`,

                    3: `Performance optimization for this ${language} code:

${this.attempts[1]?.response || ''}

OPTIMIZATION GOALS:
- Improve performance and efficiency
- Add professional documentation
- Enhance user experience
- Add responsive design (if applicable)
- Ensure cross-browser compatibility
- Polish the final code quality

Return the optimized production-ready code:`,

                    4: `Final validation and quality check for this ${language} code:

${this.attempts[2]?.response || ''}

VALIDATION CRITERIA:
- Code is complete and functional
- All features work properly
- Security measures are in place
- Performance is optimized
- Documentation is comprehensive

YOUR TASK:
- If the code meets all criteria, return the complete, unchanged code block. At the very end, on a new line, add the confirmation: "DEPLOYMENT_APPROVED".
- If any issues exist, fix them and return ONLY the complete, corrected final code block.`,

                    5: `Requirements fulfillment check and comprehensive enhancement for this ${language} code:

CURRENT CODE:
${this.getCurrentFinalCode()}

ORIGINAL USER REQUIREMENTS:
${requirements}

TASK:
Compare the current code against the user's original requirements. Create a comprehensive, complete version that fully satisfies ALL user requirements. If the current code is missing features, functionality, or doesn't meet the requirements, expand it into a complete solution.

Generate the final comprehensive code that fully delivers what the user requested:`
                };

                return prompts[stage];
            }

            generateRehabPrompt(brokenCode, problemDesc, language, stage) {
                const prompts = {
                    1: `Analyze this broken ${language} code and identify all issues:

BROKEN CODE:
${brokenCode}

REPORTED PROBLEMS:
${problemDesc}

Provide a detailed technical analysis with:
- List of identified bugs and syntax errors
- Security vulnerabilities found
- Performance issues
- Missing functionality
- Recommended fixes

Create comprehensive analysis:`,

                    2: `Fix this broken ${language} code based on the analysis:

ORIGINAL CODE:
${brokenCode}

ANALYSIS:
${this.attempts[0]?.response || ''}

PROBLEMS TO FIX:
${problemDesc}

Return the complete working code with all issues resolved:`,

                    3: `Enhance and integrate this rehabilitated ${language} code:

${this.attempts[1]?.response || ''}

INTEGRATION GOALS:
- Ensure seamless functionality
- Add missing features
- Improve code structure
- Optimize performance
- Add proper documentation

Return the enhanced integrated code:`,

                    4: `Final rehabilitation validation for this ${language} code:

${this.attempts[2]?.response || ''}

VALIDATION:
- Verify all original problems are fixed
- Ensure code is production-ready
- Check security and performance

YOUR TASK:
- If rehabilitation is complete, return the full, working code. At the very end, on a new line, add the confirmation: "REHABILITATION_COMPLETE".
- If issues remain, fix them and return ONLY the final corrected code block.`,

                    5: `Requirements fulfillment check and comprehensive enhancement for this rehabilitated ${language} code:

CURRENT REHABILITATED CODE:
${this.getCurrentFinalCode()}

ORIGINAL BROKEN CODE:
${brokenCode}

ORIGINAL PROBLEMS:
${problemDesc}

TASK:
Compare the current rehabilitated code against the original problems described. Create a comprehensive, complete version that not only fixes the original issues but provides a robust, feature-complete solution.

Generate the final comprehensive rehabilitated code:`
                };

                return prompts[stage];
            }

            getCurrentFinalCode() {
                if (this.attempts.length < 3) return '';
                
                let finalResponse = this.attempts[this.attempts.length - 2].response;
                
                const isApprovalOnly = (finalResponse.includes('DEPLOYMENT_APPROVED') || finalResponse.includes('REHABILITATION_COMPLETE')) &&
                    !finalResponse.includes('<') && !finalResponse.includes('function');

                if (isApprovalOnly && this.attempts.length > 2) {
                    return this.extractCode(this.attempts[this.attempts.length - 3].response);
                } else {
                    return this.extractCode(finalResponse);
                }
            }

            generateSetupPrompt(code, language, isRehab = false) {
                const type = isRehab ? 'rehabilitated' : 'generated';
                return `Create step-by-step setup instructions for this ${type} ${language} project:

${code}

Include:
1. File structure and organization
2. Dependencies and requirements
3. Installation steps
4. Configuration needed
5. How to run/deploy
6. Usage instructions
7. Troubleshooting tips

Provide clear, actionable setup guide:`;
            }

            async callAI(prompt, model) {
                try {
                    let processedPrompt = prompt;

                    if (prompt.length > CONFIG.MAX_PROMPT_LENGTH) {
                        const start = prompt.substring(0, 3000);
                        const end = prompt.substring(prompt.length - 3000);
                        processedPrompt = start + "\n\n[Content truncated for length]\n\n" + end;
                    }

                    const response = await fetch(`${this.baseURL}/${encodeURIComponent(processedPrompt)}?model=${model}`);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const text = await response.text();
                    return text;
                } catch (error) {
                    console.error(`Error calling ${model}:`, error);
                    throw new Error(`Could not get response from AI service: ${error.message}`);
                }
            }

            calculateConfidence(attempts) {
                if (attempts.length < 4) return 0.4;
                
                let confidence = 0.5;
                
                if (attempts.length >= 5) confidence += 0.2;
                
                const lastAttempt = attempts[attempts.length - 1];
                if (lastAttempt?.response.includes('comprehensive') || lastAttempt?.response.length > 500) {
                    confidence += 0.25;
                }
                
                const hasDocumentation = attempts.some(attempt => 
                    attempt.response.includes('//') || 
                    attempt.response.includes('/*') || 
                    attempt.response.includes('#') || 
                    attempt.response.includes('"""')
                );
                if (hasDocumentation) confidence += 0.05;
                
                return Math.min(confidence, 1.0);
            }

            extractCode(response) {
                const codeBlockMatch = response.match(/```[\w]*\s*([\s\S]*?)```/);
                if (codeBlockMatch) return codeBlockMatch[1].trim();
                
                const htmlMatch = response.match(/<!DOCTYPE html[\s\S]*?<\/html>/i);
                if (htmlMatch) return htmlMatch[0];
                
                const bodyMatch = response.match(/<body[\s\S]*?<\/body>/i);
                if (bodyMatch) return bodyMatch[0];
                
                return response;
            }

            async generate(requirements, language, onProgress) {
                this.attempts = [];
                
                for (let stage = 1; stage <= 5; stage++) {
                    onProgress?.({ stage: stage, status: 'working' });
                    
                    const prompt = this.generatePrompt(requirements, language, stage);
                    const response = await this.callAI(prompt, this.models[stage - 1]);
                    
                    this.attempts.push({
                        stage: stage,
                        model: this.models[stage - 1],
                        response: response,
                        role: ['generator', 'security', 'optimizer', 'validator', 'fulfillment'][stage - 1]
                    });
                    
                    onProgress?.({ stage: stage, status: 'completed' });
                    
                    await new Promise(resolve => setTimeout(resolve, CONFIG.STAGE_DELAY_MS));
                }

                let finalCode = this.extractCode(this.attempts[4].response);
                const setupPrompt = this.generateSetupPrompt(finalCode, language, false);
                const setupInstructions = await this.callAI(setupPrompt, 'openai-fast ');
                const confidence = this.calculateConfidence(this.attempts);

                return {
                    requirements,
                    language,
                    attempts: this.attempts,
                    finalCode: finalCode + '\n\n',
                    setupInstructions: setupInstructions + '\n\n--- üõ°Ô∏è CYBERNOX-CODE - Secure AI Generation',
                    confidence: confidence,
                    type: 'generation',
                    timestamp: new Date().toISOString()
                };
            }

            async rehabilitate(brokenCode, problemDesc, language, onProgress) {
                this.attempts = [];
                
                for (let stage = 1; stage <= 5; stage++) {
                    onProgress?.({ stage: stage, status: 'working' });
                    
                    const prompt = this.generateRehabPrompt(brokenCode, problemDesc, language, stage);
                    const response = await this.callAI(prompt, this.models[stage - 1]);
                    
                    this.attempts.push({
                        stage: stage,
                        model: this.models[stage - 1],
                        response: response,
                        role: ['analyzer', 'fixer', 'integrator', 'validator', 'fulfillment'][stage - 1]
                    });
                    
                    onProgress?.({ stage: stage, status: 'completed' });
                    
                    await new Promise(resolve => setTimeout(resolve, CONFIG.STAGE_DELAY_MS));
                }

                let finalCode = this.extractCode(this.attempts[4].response);
                const setupPrompt = this.generateSetupPrompt(finalCode, language, true);
                const setupInstructions = await this.callAI(setupPrompt, 'openai-fast ');
                const confidence = this.calculateConfidence(this.attempts);

                return {
                    originalCode: brokenCode,
                    problemDescription: problemDesc,
                    language,
                    attempts: this.attempts,
                    finalCode: finalCode + '\n\n',
                    setupInstructions: setupInstructions + '\n\n--- üõ°Ô∏è CYBERNOX-CODE - Code Rehabilitation',
                    confidence: confidence,
                    type: 'rehabilitation',
                    timestamp: new Date().toISOString()
                };
            }

            async sendChatMessage(message, chatHistory = []) {
                let conversationContext = '';
                
                if (chatHistory.length > 0) {
                    conversationContext = 'PREVIOUS CONVERSATION:\n';
                    chatHistory.forEach(msg => {
                        const role = msg.role === 'user' ? 'USER' : msg.role === 'assistant' ? 'ASSISTANT' : 'SYSTEM';
                        conversationContext += `${role}: ${msg.message}\n`;
                    });
                    conversationContext += '\n---\n\n';
                }

                const chatPrompt = `You are CYBERNOX AI, a helpful coding assistant for the CYBERNOX-CODE platform. You help users plan and build their projects with continuity across sessions. When asked you are asked who created you, you say, CYBERNOX Research & Development Team.

${conversationContext}CURRENT USER MESSAGE: ${message}

INSTRUCTIONS:
- Maintain conversation context and remember previous discussions
- Help with technical requirements, clarifications, and recommendations
- Suggest best practices, platforms, and frameworks
- Provide project planning and architecture guidance
- Reference previous messages when relevant
- If the user seems ready to start coding, end your response with "READY_TO_CODE"

Respond as CYBERNOX AI with full context awareness:`;

                return await this.callAI(chatPrompt, 'openai-fast ');
            }
        }

        /**
         * User Interface Controller - Integrated with Mini IDE
         */
        class UIController {
            constructor() {
                this.generator = new CodeGenerator();
                this.isProcessing = false;
                this.currentResult = null;
                
                this.initializeElements();
                this.bindEvents();
                this.initializeChat();
            }

            initializeElements() {
                this.elements = {
                    modeToggle: document.getElementById('modeToggle'),
                    modeIndicator: document.getElementById('modeIndicator'),
                    generatorSection: document.getElementById('generatorSection'),
                    rehabSection: document.getElementById('rehabSection'),
                    
                    requirements: document.getElementById('requirements'),
                    language: document.getElementById('language'),
                    generateBtn: document.getElementById('generateBtn'),
                    clearGeneratorBtn: document.getElementById('clearGeneratorBtn'),
                    
                    brokenCode: document.getElementById('brokenCode'),
                    problemDescription: document.getElementById('problemDescription'),
                    rehabLanguage: document.getElementById('rehabLanguage'),
                    rehabBtn: document.getElementById('rehabBtn'),
                    clearRehabBtn: document.getElementById('clearRehabBtn'),
                    
                    pipelineProgress: document.getElementById('pipelineProgress'),
                    progressFill: document.getElementById('progressFill'),
                    stageStatus: document.getElementById('stageStatus'),
                    
                    resultsSection: document.getElementById('resultsSection'),
                    confidenceFill: document.getElementById('confidenceFill'),
                    confidenceText: document.getElementById('confidenceText'),
                    codeTitle: document.getElementById('codeTitle'),
                    codeContent: document.getElementById('codeContent'),
                    setupContent: document.getElementById('setupContent'),
                    copyCodeBtn: document.getElementById('copyCodeBtn'),
                    copySetupBtn: document.getElementById('copySetupBtn'),
                    editCodeBtn: document.getElementById('editCodeBtn'),
                    
                    // MINI IDE PREVIEW INTEGRATION
                    previewSection: document.getElementById('previewSection'),
                    previewContainer: document.getElementById('previewContainer'),
                    previewFrame: document.getElementById('preview-frame'),
                    
                    chatContainer: document.getElementById('chatContainer'),
                    chatInput: document.getElementById('chatInput'),
                    chatBtn: document.getElementById('chatBtn'),
                    
                    manageSessionsBtn: document.getElementById('manageSessionsBtn'),
                    sessionModal: document.getElementById('sessionModal'),
                    closeModalBtn: document.getElementById('closeModalBtn'),
                    sessionNameInput: document.getElementById('sessionNameInput'),
                    saveSessionBtn: document.getElementById('saveSessionBtn'),
                    savedSessionsList: document.getElementById('savedSessionsList'),
                    
                    errorDisplay: document.getElementById('errorDisplay')
                };
            }

            bindEvents() {
                this.elements.modeToggle.addEventListener('click', () => this.toggleMode());
                
                this.elements.generateBtn.addEventListener('click', () => this.startGeneration());
                this.elements.rehabBtn.addEventListener('click', () => this.startRehabilitation());
                
                this.elements.chatBtn.addEventListener('click', () => this.sendChat());
                this.elements.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isProcessing) this.sendChat();
                });
                
                this.elements.copyCodeBtn.addEventListener('click', () => this.copyCode());
                this.elements.copySetupBtn.addEventListener('click', () => this.copySetup());
                this.elements.editCodeBtn.addEventListener('click', () => this.editCode());
                
                this.elements.clearGeneratorBtn.addEventListener('click', () => this.resetAll());
                this.elements.clearRehabBtn.addEventListener('click', () => this.resetAll());
                
                this.elements.manageSessionsBtn.addEventListener('click', () => this.openSessionModal());
                this.elements.closeModalBtn.addEventListener('click', () => this.closeSessionModal());
                this.elements.sessionModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.sessionModal) this.closeSessionModal();
                });
                this.elements.saveSessionBtn.addEventListener('click', () => this.saveCurrentSession());
                this.elements.savedSessionsList.addEventListener('click', (e) => this.handleSessionListClick(e));
                
                const textareas = document.querySelectorAll('.textarea-field');
                textareas.forEach(textarea => {
                    textarea.addEventListener('input', (e) => {
                        e.target.style.height = 'auto';
                        e.target.style.height = Math.min(e.target.scrollHeight, 400) + 'px';
                    });
                });
            }

            // MINI IDE INTEGRATION - Edit Code
            editCode() {
                if (!this.currentResult) {
                    this.showNotification('No code to edit. Generate code first!', 3000);
                    return;
                }
                
                miniIDE.show(this.currentResult.finalCode);
            }

            initializeChat() {
                this.loadChatHistory();
                
                if (this.generator.chatHistory.length === 0) {
                    this.addChatMessage('system', 'Welcome to CYBERNOX-CODE! Describe your project or load a previous session.');
                }
            }

            loadChatHistory() {
                try {
                    const savedChat = localStorage.getItem(CONFIG.STORAGE_KEYS.CHAT_HISTORY);
                    if (savedChat) {
                        const chatData = JSON.parse(savedChat);
                        this.generator.chatHistory = chatData || [];
                        this.elements.chatContainer.innerHTML = '';
                        
                        this.generator.chatHistory.forEach(msg => {
                            this.addChatMessage(msg.role, msg.message, true);
                        });
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    this.generator.chatHistory = [];
                }
            }

            saveChatHistory() {
                try {
                    localStorage.setItem(CONFIG.STORAGE_KEYS.CHAT_HISTORY, JSON.stringify(this.generator.chatHistory));
                } catch (error) {
                    console.error('Error saving chat history:', error);
                }
            }
            
            updateModeUI(isRehab) {
                if (isRehab) {
                    this.elements.modeToggle.textContent = 'üöë Code Rehab';
                    this.elements.modeToggle.className = 'mode-toggle rehab';
                    this.elements.modeIndicator.textContent = 'üöë Code Rehabilitation Mode';
                    this.elements.generatorSection.style.display = 'none';
                    this.elements.rehabSection.style.display = 'block';
                } else {
                    this.elements.modeToggle.textContent = '‚ö° Code Generator';
                    this.elements.modeToggle.className = 'mode-toggle generator';
                    this.elements.modeIndicator.textContent = '‚ö° AI Code Generation Mode';
                    this.elements.generatorSection.style.display = 'block';
                    this.elements.rehabSection.style.display = 'none';
                }
            }

            toggleMode() {
                this.generator.isRehabMode = !this.generator.isRehabMode;
                this.updateModeUI(this.generator.isRehabMode);
                
                const message = this.generator.isRehabMode ? 
                    'Code Rehabilitation mode activated!' : 
                    'Code Generation mode activated!';
                this.addChatMessage('system', message);
                this.resetResultsDisplay();
            }

            async startGeneration() {
                const requirements = this.elements.requirements.value.trim();
                const language = this.elements.language.value;
                
                if (!requirements || this.isProcessing) return;

                this.resetResultsDisplay();
                this.isProcessing = true;
                this.elements.generateBtn.disabled = true;
                this.elements.generateBtn.textContent = 'üîÑ Generating...';
                this.elements.chatBtn.disabled = true;
                this.showProgress();

                try {
                    const result = await this.generator.generate(
                        requirements, 
                        language, 
                        (progress) => this.updateProgress(progress)
                    );
                    
                    this.displayResults(result);
                    this.addChatMessage('system', '‚úÖ Code generation completed successfully!');
                } catch (error) {
                    console.error('Generation error:', error);
                    this.showError(`Generation failed: ${error.message}`);
                    this.addChatMessage('system', `‚ùå Generation failed: ${error.message}`);
                } finally {
                    this.isProcessing = false;
                    this.elements.generateBtn.disabled = false;
                    this.elements.generateBtn.textContent = 'üöÄ Generate Secure Code';
                    this.elements.chatBtn.disabled = false;
                    this.hideProgress();
                }
            }

            async startRehabilitation() {
                const brokenCode = this.elements.brokenCode.value.trim();
                const problemDesc = this.elements.problemDescription.value.trim();
                const language = this.elements.rehabLanguage.value;

                if (!brokenCode || !problemDesc || this.isProcessing) return;

                this.resetResultsDisplay();
                this.isProcessing = true;
                this.elements.rehabBtn.disabled = true;
                this.elements.rehabBtn.textContent = 'üîÑ Rehabilitating...';
                this.elements.chatBtn.disabled = true;
                this.showProgress();

                try {
                    const result = await this.generator.rehabilitate(
                        brokenCode, 
                        problemDesc, 
                        language, 
                        (progress) => this.updateProgress(progress)
                    );
                    
                    this.displayResults(result);
                    this.addChatMessage('system', '‚úÖ Code rehabilitation completed successfully!');
                } catch (error) {
                    console.error('Rehabilitation error:', error);
                    this.showError(`Rehabilitation failed: ${error.message}`);
                    this.addChatMessage('system', `‚ùå Rehabilitation failed: ${error.message}`);
                } finally {
                    this.isProcessing = false;
                    this.elements.rehabBtn.disabled = false;
                    this.elements.rehabBtn.textContent = 'üöë Rehabilitate Code';
                    this.elements.chatBtn.disabled = false;
                    this.hideProgress();
                }
            }

            showProgress() {
                this.elements.pipelineProgress.style.display = 'block';
                this.elements.progressFill.style.width = '0%';
                this.elements.resultsSection.style.display = 'none';
                this.elements.previewSection.style.display = 'none';
                
                const stageCards = this.elements.stageStatus.querySelectorAll('.stage-card');
                stageCards.forEach(card => card.classList.remove('active', 'completed'));
            }

            hideProgress() {
                this.elements.pipelineProgress.style.display = 'none';
            }

            updateProgress(progress) {
                const progressPercent = (progress.stage / 5) * 100;
                this.elements.progressFill.style.width = `${progressPercent}%`;
                
                const stageNames = ['generator', 'security', 'optimizer', 'validator', 'fulfillment'];
                const stageName = stageNames[progress.stage - 1];
                const stageCard = document.getElementById(`stage-${stageName}`);
                
                if (stageCard) {
                    if (progress.status === 'working') {
                        stageCard.classList.add('active');
                    } else if (progress.status === 'completed') {
                        stageCard.classList.remove('active');
                        stageCard.classList.add('completed');
                    }
                }
            }

            displayResults(result) {
                this.currentResult = result;
                
                if (!result) {
                    this.resetResultsDisplay();
                    return;
                }

                this.elements.resultsSection.style.display = 'block';
                
                const confidencePercent = (result.confidence * 100).toFixed(1);
                this.elements.confidenceFill.style.width = `${confidencePercent}%`;
                this.elements.confidenceText.innerHTML = `<strong>${confidencePercent}%</strong>`;
                
                this.elements.codeTitle.textContent = result.type === 'rehabilitation' ? 
                    'üöë Rehabilitated Code' : 'üìù Generated Code';
                this.elements.codeContent.innerHTML = `<pre><code>${this.escapeHtml(result.finalCode)}</code></pre>`;
                this.elements.setupContent.innerHTML = this.formatSetupInstructions(result.setupInstructions);
                
                // MINI IDE PREVIEW INTEGRATION
                if (['html', 'css', 'react', 'javascript'].includes(result.language)) {
                    this.showMiniIDEPreview(result.finalCode);
                } else {
                    this.elements.previewSection.style.display = 'none';
                }
                
                this.elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
            }

            // COMPLETE IFRAME ISOLATION - ALL INTERACTIONS STAY IN PREVIEW
            showMiniIDEPreview(code) {
                try {
                    if (!code.trim()) {
                        this.elements.previewFrame.srcdoc = '<body style="padding:20px;color:#666;font-family:sans-serif;">Preview will appear here...</body>';
                        this.elements.previewSection.style.display = 'block';
                        return;
                    }
                    
                    const processedCode = this.processCodeForPreview(code);
                    this.elements.previewFrame.srcdoc = processedCode;
                    this.elements.previewSection.style.display = 'block';
                    
                    setTimeout(() => {
                        this.elements.previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 500);
                } catch (error) {
                    console.error('Preview display error:', error);
                    this.showError(`Preview failed: ${error.message}`);
                }
            }

            // COMPLETE ISOLATION - BLOCKS ALL PARENT COMMUNICATION
            processCodeForPreview(code) {
                // Remove CSP headers that might interfere
                const cspMetaTagRegex = /<meta http-equiv="Content-Security-Policy"[^>]*>/gi;
                let processedCode = code.replace(cspMetaTagRegex, '');
                
                // COMPLETE ISOLATION SCRIPT - BLOCKS ALL PARENT ACCESS
                const isolationScript = `<script>
(function() {
    'use strict';
    
    // BLOCK ALL PARENT ACCESS
    try {
        Object.defineProperty(window, 'parent', { value: window, writable: false });
        Object.defineProperty(window, 'top', { value: window, writable: false });
        Object.defineProperty(window, 'frameElement', { value: null, writable: false });
    } catch(e) {}
    
    // OVERRIDE NAVIGATION TO STAY IN IFRAME
    const originalOpen = window.open;
    window.open = function() { return window; };
    
    // BLOCK POSTMESSAGE TO PARENT
    const originalPostMessage = window.postMessage;
    window.postMessage = function(message, targetOrigin) {
        // Only allow postMessage within same window
        return originalPostMessage.call(window, message, window.location.origin);
    };
    
    // HANDLE ALL NAVIGATION WITHIN IFRAME
    document.addEventListener('DOMContentLoaded', function() {
        
        // OVERRIDE ALL ANCHOR CLICKS TO STAY IN IFRAME
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (!link) return;
            
            const href = link.getAttribute('href');
            if (!href) return;
            
            // Handle hash links within iframe (like #menu, #locations)
            if (href.startsWith('#')) {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
                return;
            }
            
            // Block external navigation - keep everything in iframe
            if (href.startsWith('http') || href.startsWith('//') || href.startsWith('mailto:') || href.startsWith('tel:')) {
                e.preventDefault();
                console.log('External link blocked in preview:', href);
                return;
            }
            
            // Allow relative links within iframe
            if (href.startsWith('/') || href.startsWith('./') || href.startsWith('../')) {
                // These would normally navigate within iframe anyway
                return;
            }
        }, true);
        
        // OVERRIDE FORM SUBMISSIONS TO STAY IN IFRAME
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (!form.tagName || form.tagName.toLowerCase() !== 'form') return;
            
            // Block form submissions that might escape iframe
            const action = form.getAttribute('action');
            if (action && (action.startsWith('http') || action.startsWith('//'))) {
                e.preventDefault();
                console.log('External form submission blocked in preview');
                
                // Show fake success for demo purposes
                const formData = new FormData(form);
                console.log('Form data (preview only):', Object.fromEntries(formData));
                
                // Trigger any success messages within the iframe
                const event = new CustomEvent('formSuccess', { detail: { formData } });
                form.dispatchEvent(event);
            }
        }, true);
        
        // BLOCK WINDOW LOCATION CHANGES
        const originalLocation = window.location;
        Object.defineProperty(window, 'location', {
            get: function() { return originalLocation; },
            set: function(value) { 
                console.log('Location change blocked in preview:', value);
                return originalLocation; 
            }
        });
        
        // BLOCK HISTORY API THAT MIGHT AFFECT PARENT
        const originalPushState = history.pushState;
        const originalReplaceState = history.replaceState;
        
        history.pushState = function(state, title, url) {
            if (url && url.startsWith('#')) {
                return originalPushState.call(history, state, title, url);
            }
            console.log('History change blocked in preview');
        };
        
        history.replaceState = function(state, title, url) {
            if (url && url.startsWith('#')) {
                return originalReplaceState.call(history, state, title, url);
            }
            console.log('History change blocked in preview');
        };
    });
    
    // BLOCK DOCUMENT.WRITE THAT MIGHT BREAK ISOLATION
    const originalWrite = document.write;
    document.write = function(content) {
        console.log('document.write blocked in preview');
    };
    
    // BLOCK DOCUMENT.WRITELN
    const originalWriteln = document.writeln;
    document.writeln = function(content) {
        console.log('document.writeln blocked in preview');
    };
    
})();
<\/script>`;
                
                // Inject isolation script at the very beginning
                if (processedCode.toLowerCase().includes('<head>')) {
                    processedCode = processedCode.replace(/<head>/i, '<head>' + isolationScript);
                } else if (processedCode.toLowerCase().includes('<html')) {
                    processedCode = processedCode.replace(/<html[^>]*>/i, '$&<head>' + isolationScript + '</head>');
                } else {
                    processedCode = isolationScript + processedCode;
                }
                
                return processedCode;
            }

            formatSetupInstructions(instructions) {
                return this.escapeHtml(instructions)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/#{1}\s+(.*)/g, '<h2 style="color: #00d4ff; margin: 20px 0 10px 0;">$1</h2>')
                    .replace(/#{2}\s+(.*)/g, '<h3 style="color: #00d4ff; margin: 15px 0 8px 0;">$1</h3>')
                    .replace(/`([^`]+)`/g, '<code style="background: #2a2a3a; padding: 2px 6px; border-radius: 3px; color: #00d4ff;">$1</code>')
                    .replace(/\n\n/g, '</p><p style="margin-bottom: 10px;">')
                    .replace(/^(.*)/, '<p style="margin-bottom: 10px;">$1')
                    .replace(/(.*)$/, '$1</p>');
            }

            async sendChat() {
                const message = this.elements.chatInput.value.trim();
                if (!message || this.isProcessing) return;

                this.elements.chatInput.value = '';
                this.addChatMessage('user', message);

                try {
                    const response = await this.generator.sendChatMessage(message, this.generator.chatHistory);
                    this.addChatMessage('assistant', response);
                    
                    if (response.includes('READY_TO_CODE')) {
                        this.populateRequirementsFromChat();
                        this.showNotification('Ready to generate code!', 3000);
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    this.addChatMessage('system', '‚ùå Chat temporarily unavailable. Please try again.');
                }
            }

            ensureChatPersistence() {
                if (this.currentResult) {
                    this.currentResult.chatHistory = this.generator.chatHistory;
                }
                this.saveChatHistory();
            }

            addChatMessage(role, message, isHistory = false) {
                try {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${role}-message`;
                    
                    const icons = { user: 'üë§', assistant: 'ü§ñ', system: '‚öôÔ∏è' };
                    const names = { user: 'YOU', assistant: 'CYBERNOX AI', system: 'SYSTEM' };
                
                    const hasReadyToCode = role === 'assistant' && message.includes('READY_TO_CODE');
                    const cleanMessage = message.replace(/READY_TO_CODE/g, '').trim();
                
                    messageDiv.innerHTML = `
                        <div class="message-header">
                            <span>${icons[role]}</span>
                            <span>${names[role]}</span>
                        </div>
                        <div class="message-content">${this.escapeHtml(cleanMessage).replace(/\n/g, '<br>')}</div>
                    `;
                    
                    this.elements.chatContainer.appendChild(messageDiv);
                    
                    setTimeout(() => {
                        if (!isHistory && role === 'assistant') {
                            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                    }, 100);
                    
                    if (!isHistory) {
                        this.generator.chatHistory.push({ role, message: cleanMessage });
                        this.ensureChatPersistence();
                        this.saveChatHistory();
                    }
                } catch (error) {
                    console.error('Error adding chat message:', error);
                }
            }

            populateRequirementsFromChat() {
                const userMessages = this.generator.chatHistory
                    .filter(msg => msg.role === 'user')
                    .map(msg => msg.message)
                    .join('. ');
                
                if (userMessages && !this.generator.isRehabMode) {
                    this.elements.requirements.value = userMessages;
                }
            }

            showNotification(message, duration = CONFIG.NOTIFICATION_DURATION) {
                const notification = document.createElement('div');
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 15px 20px; border-radius: 8px; font-weight: 600; z-index: 10001; animation: slideIn 0.3s ease; max-width: 300px;';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => { 
                            if (document.body.contains(notification)) { 
                                document.body.removeChild(notification); 
                            } 
                        }, 300);
                    }
                }, duration);
            }
            
            openSessionModal() {
                this.elements.sessionModal.style.display = 'flex';
                this.populateSessionsList();
            }
            
            closeSessionModal() {
                this.elements.sessionModal.style.display = 'none';
            }
            
            getSessions() {
                try { 
                    return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.SESSIONS)) || {}; 
                } catch (e) { 
                    return {}; 
                }
            }
            
            saveSessions(sessions) {
                try { 
                    localStorage.setItem(CONFIG.STORAGE_KEYS.SESSIONS, JSON.stringify(sessions)); 
                } catch (error) { 
                    this.showError('Failed to save session. Storage may be full.'); 
                }
            }
            
            formatTimestamp(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }

            populateSessionsList() {
                const sessions = this.getSessions();
                const sessionKeys = Object.keys(sessions);
                this.elements.savedSessionsList.innerHTML = '';
                
                if (sessionKeys.length === 0) {
                    this.elements.savedSessionsList.innerHTML = '<div class="no-sessions-msg">No saved sessions yet. Create one above!</div>';
                    return;
                }
                
                sessionKeys.sort((a, b) => new Date(sessions[b].timestamp || 0) - new Date(sessions[a].timestamp || 0));
                
                sessionKeys.forEach(key => {
                    const session = sessions[key];
                    const item = document.createElement('div');
                    item.className = 'session-item';
                    
                    const modeText = session.isRehabMode ? 'Code Rehab' : 'Code Generator';
                    const modeClass = session.isRehabMode ? 'session-mode-rehab' : 'session-mode-generator';
                    const timestamp = session.timestamp ? this.formatTimestamp(session.timestamp) : 'No timestamp';
                    const language = session.inputs?.language || session.inputs?.rehabLanguage || 'Unknown';
                    
                    item.innerHTML = `
                        <div class="session-item-info">
                            <div class="session-item-name">${this.escapeHtml(key)}</div>
                            <div class="session-item-details">
                                <div><span class="session-mode-badge ${modeClass}">${modeText}</span><span style="color: #00d4ff; margin-left: 10px;">${language.toUpperCase()}</span></div>
                                <div class="session-timestamp">üìÖ ${timestamp}</div>
                            </div>
                        </div>
                        <div class="session-item-actions">
                            <button class="load-session-btn" data-session-key="${this.escapeHtml(key)}">üìÇ Load</button>
                            <button class="delete-session-btn" data-session-key="${this.escapeHtml(key)}">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    this.elements.savedSessionsList.appendChild(item);
                });
            }

            saveCurrentSession() {
                try {
                    let name = this.elements.sessionNameInput.value.trim();
                    
                    if (!name) {
                        const now = new Date();
                        const dateStr = now.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        });
                        const mode = this.generator.isRehabMode ? 'Rehab' : 'Generator';
                        const language = this.generator.isRehabMode ? 
                            (this.elements.rehabLanguage.value || 'Code') : 
                            (this.elements.language.value || 'Code');
                        name = `${mode} Session - ${language.toUpperCase()} - ${dateStr}`;
                    }
                    
                    const sessionData = {
                        name: name,
                        isRehabMode: this.generator.isRehabMode,
                        timestamp: new Date().toISOString(),
                        inputs: {
                            requirements: this.elements.requirements.value || '',
                            language: this.elements.language.value || 'html',
                            brokenCode: this.elements.brokenCode.value || '',
                            problemDescription: this.elements.problemDescription.value || '',
                            rehabLanguage: this.elements.rehabLanguage.value || 'html',
                        },
                        chatHistory: [...this.generator.chatHistory],
                        result: this.currentResult ? { ...this.currentResult } : null
                    };
                    
                    const sessions = this.getSessions();
                    sessions[name] = sessionData;
                    this.saveSessions(sessions);
                    
                    this.showNotification(`Session "${name}" saved successfully! üéâ`);
                    this.elements.sessionNameInput.value = '';
                    this.populateSessionsList();
                } catch (error) {
                    console.error('Save session error:', error);
                    this.showError('Failed to save session');
                }
            }
            
            handleSessionListClick(event) {
                const key = event.target.getAttribute('data-session-key');
                if (!key) return;
                
                if (event.target.classList.contains('load-session-btn')) {
                    this.loadSession(key);
                } else if (event.target.classList.contains('delete-session-btn')) {
                    this.deleteSession(key);
                }
            }
            
            loadSession(key) {
                try {
                    const sessions = this.getSessions();
                    const session = sessions[key];
                    
                    if (!session) {
                        this.showNotification('Error: Session not found.', 3000);
                        return;
                    }
                    
                    this.resetResultsDisplay();
                    
                    this.generator.isRehabMode = session.isRehabMode || false;
                    this.updateModeUI(this.generator.isRehabMode);
                    
                    this.elements.requirements.value = session.inputs?.requirements || '';
                    this.elements.language.value = session.inputs?.language || 'html';
                    this.elements.brokenCode.value = session.inputs?.brokenCode || '';
                    this.elements.problemDescription.value = session.inputs?.problemDescription || '';
                    this.elements.rehabLanguage.value = session.inputs?.rehabLanguage || 'html';
                    
                    this.generator.chatHistory = [];
                    this.elements.chatContainer.innerHTML = '';
                    
                    if (session.chatHistory && Array.isArray(session.chatHistory)) {
                        session.chatHistory.forEach(msg => {
                            if (msg && msg.role && msg.message) {
                                this.generator.chatHistory.push({ role: msg.role, message: msg.message });
                                this.addChatMessage(msg.role, msg.message, true);
                            }
                        });
                        this.saveChatHistory();
                    }
                    
                    if (this.generator.chatHistory.length === 0) {
                        this.addChatMessage('system', `Session "${key}" loaded successfully!`);
                    }
                    
                    if (session.result) {
                        this.displayResults(session.result);
                    }
                    
                    this.closeSessionModal();
                    this.showNotification(`Session "${key}" loaded!`);
                } catch (error) {
                    console.error('Load session error:', error);
                    this.showError('Failed to load session');
                }
            }

            deleteSession(key) {
                if (confirm(`Are you sure you want to delete the session "${key}"? This cannot be undone.`)) {
                    try {
                        const sessions = this.getSessions();
                        delete sessions[key];
                        this.saveSessions(sessions);
                        this.populateSessionsList();
                        this.showNotification(`Session "${key}" deleted.`);
                    } catch (error) {
                        console.error('Delete session error:', error);
                        this.showError('Failed to delete session');
                    }
                }
            }

            async copyCode() {
                if (!this.currentResult) return;
                await this.copyToClipboard(this.currentResult.finalCode, 'Code copied!');
            }

            async copySetup() {
                if (!this.currentResult) return;
                await this.copyToClipboard(this.currentResult.setupInstructions, 'Setup guide copied!');
            }

            async copyToClipboard(text, successMessage) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        
                        if (!document.execCommand('copy')) { 
                            throw new Error('Copy command failed'); 
                        }
                        
                        document.body.removeChild(textArea);
                    }
                    
                    this.showCopyFeedback();
                    this.showNotification(successMessage);
                } catch (error) {
                    console.error('Copy failed:', error);
                    this.showNotification('Copy failed. Please copy manually.');
                }
            }

            showCopyFeedback() {
                const copyBtns = document.querySelectorAll('.copy-btn');
                copyBtns.forEach(btn => {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì Copied!';
                    btn.classList.add('copied');
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                });
            }

            escapeHtml(text = '') {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            resetResultsDisplay() {
                this.currentResult = null;
                this.elements.resultsSection.style.display = 'none';
                this.elements.previewSection.style.display = 'none';
                this.elements.errorDisplay.style.display = 'none';
            }

            resetAll() {
                try {
                    this.resetResultsDisplay();
                    
                    this.elements.requirements.value = '';
                    this.elements.brokenCode.value = '';
                    this.elements.problemDescription.value = '';
                    
                    this.generator.chatHistory = [];
                    localStorage.removeItem(CONFIG.STORAGE_KEYS.CHAT_HISTORY);
                    this.elements.chatContainer.innerHTML = '';
                    this.addChatMessage('system', 'All data cleared. Ready for new project!');
                } catch (error) {
                    console.error('Reset error:', error);
                    this.showError('Reset failed, please refresh the page');
                }
            }

            showError(message) {
                this.elements.errorDisplay.textContent = message;
                this.elements.errorDisplay.style.display = 'block';
                
                setTimeout(() => {
                    if (this.elements.errorDisplay.style.display === 'block') {
                        this.elements.errorDisplay.style.display = 'none';
                    }
                }, 5000);
            }
        }

        /**
         * Application initialization and global setup
         */
        let ui;
        let miniIDE;
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                ui = new UIController();
                miniIDE = new MiniIDE();
                
                // Global access for debugging
                window.ui = ui; 
                window.miniIDE = miniIDE;
                
                // Production navigation guard
                window.addEventListener('beforeunload', (e) => {
                    // Silent guard - no debug logging in production
                });
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.body.innerHTML = '<div style="background: #e74c3c; color: white; padding: 40px; text-align: center; font-family: Arial; border-radius: 10px; margin: 20px;"><h2>‚ö†Ô∏è CYBERNOX-CODE Failed to Load</h2><p>Please refresh and try again.</p></div>';
            }
        });

        // Animation styles for notifications
        const style = document.createElement('style');
        style.textContent = '@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }';
        document.head.appendChild(style);
    </script>
</body>
</html>